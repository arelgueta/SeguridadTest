<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Seguridad en Sistemas</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="admin-page">
    <div class="container">
        <header>
            <div class="logo">
                <h1>üè† Seguridad en Sistemas - Panel de Control</h1>
                <p>Gesti√≥n de dispositivos conectados</p>
            </div>
            <div class="status" id="status">
                <span class="status-dot"></span>
                <span>Sistema activo - <span id="deviceCount">0</span> dispositivos</span>
            </div>
        </header>
        
        <div class="main-content">
            <div class="video-container">
                <div class="video-header">
                    <h2>Vista previa principal</h2>
                    <div id="currentDevice">No hay dispositivos seleccionados</div>
                </div>
                <div class="video-wrapper">
                    <img id="videoFrame" src="" alt="Transmisi√≥n en vivo" style="width:100%; display:none;">
                    <div id="videoPlaceholder" class="video-placeholder">
                        <p>Selecciona un dispositivo para ver su transmisi√≥n</p>
                    </div>
                </div>
            </div>
            
            <div class="devices-panel">
                <h2 class="panel-title">
                    <span>üì± Dispositivos conectados</span>
                </h2>
                
                <div class="devices-list" id="devicesList">
                    <div class="empty-state">
                        <p>No hay dispositivos conectados</p>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-secondary" id="refreshBtn">
                        <span>‚Üª Actualizar</span>
                    </button>
                    <button class="btn btn-primary" id="broadcastBtn" disabled>
                        <span>‚ñ∂ Transmitir en pantalla</span>
                    </button>
                </div>
                
                <div class="stream-info">
                    <h3>Informaci√≥n del Stream</h3>
                    <p>FPS: <span id="fpsCounter">0</span></p>
                    <p>√öltimo frame: <span id="lastFrameTime">-</span></p>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io({
            transports: ['websocket', 'polling']
        });
        
        let selectedDeviceId = null;
        let connectedDevices = [];
        let frameCount = 0;
        let fps = 0;
        let lastFrameTime = 0;
        
        // Elementos DOM
        const devicesList = document.getElementById('devicesList');
        const deviceCount = document.getElementById('deviceCount');
        const currentDevice = document.getElementById('currentDevice');
        const videoFrame = document.getElementById('videoFrame');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const broadcastBtn = document.getElementById('broadcastBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const fpsCounter = document.getElementById('fpsCounter');
        const lastFrameTimeElement = document.getElementById('lastFrameTime');
        
        // Calcular FPS
        function updateFPS() {
            const now = Date.now();
            if (lastFrameTime > 0) {
                frameCount++;
                if (now - lastFrameTime >= 1000) {
                    fps = frameCount;
                    frameCount = 0;
                    lastFrameTime = now;
                    fpsCounter.textContent = fps;
                }
            }
        }
        
        // Actualizar lista de dispositivos
        function updateDevicesList(devices) {
            deviceCount.textContent = devices.length;
            connectedDevices = devices;
            
            if (devices.length === 0) {
                devicesList.innerHTML = '<div class="empty-state"><p>No hay dispositivos conectados</p></div>';
                broadcastBtn.disabled = true;
                currentDevice.textContent = 'No hay dispositivos seleccionados';
                return;
            }
            
            devicesList.innerHTML = '';
            devices.forEach(device => {
                const isActive = device.id === selectedDeviceId;
                const deviceElement = document.createElement('div');
                deviceElement.className = `device-card ${isActive ? 'active' : ''}`;
                deviceElement.innerHTML = `
                    <div class="device-header">
                        <div class="device-name">${device.name}</div>
                        <div class="device-time">Conectado hace ${Math.round((new Date() - new Date(device.timestamp)) / 1000)} seg</div>
                    </div>
                    <div class="device-status">
                        <span class="status-indicator ${device.streamActive ? 'active' : 'inactive'}"></span>
                        ${device.streamActive ? 'Transmitiendo' : 'Inactivo'}
                    </div>
                `;
                
                deviceElement.addEventListener('click', () => {
                    selectedDeviceId = device.id;
                    currentDevice.textContent = device.name;
                    updateDevicesList(connectedDevices);
                    broadcastBtn.disabled = false;
                    
                    // Solicitar stream actual del dispositivo
                    socket.emit('get-stream', device.id);
                });
                
                devicesList.appendChild(deviceElement);
            });
        }
        
        // Solicitar transmisi√≥n de un dispositivo
        function requestDeviceStream(deviceId) {
            socket.emit('request-view', deviceId);
            videoPlaceholder.innerHTML = '<p>Conectando con el dispositivo...</p>';
        }
        
        // Configurar eventos
        broadcastBtn.addEventListener('click', () => {
            if (selectedDeviceId) {
                requestDeviceStream(selectedDeviceId);
            }
        });
        
        refreshBtn.addEventListener('click', () => {
            socket.emit('get-devices');
        });
        
        // Eventos de Socket.io
        socket.on('connect', () => {
            console.log('Conectado al servidor');
            socket.emit('get-devices');
        });
        
        socket.on('devices-updated', updateDevicesList);
        
        socket.on('video-frame', (data) => {
            if (data.deviceId === selectedDeviceId) {
                // Mostrar el frame de video
                videoFrame.src = data.frame;
                videoFrame.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                
                // Actualizar informaci√≥n del frame
                lastFrameTime = Date.now();
                lastFrameTimeElement.textContent = new Date(data.timestamp).toLocaleTimeString();
                updateFPS();
            }
        });
        
        // Actualizar FPS cada segundo
        setInterval(updateFPS, 1000);
    </script>
</body>
</html>
